name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  workflow_call:  # Allow other workflows to call this one

jobs:
  python-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install workspace packages (root pyproject.toml is workspace manifest, not installable)
          pip install -e packages/core
          pip install -e packages/bastion
          pip install pytest pytest-cov pytest-mock

      - name: Run Tests
        run: |
          # Skip integration tests in CI (require 1Password authentication)
          # TODO: Set up 1Password service account for CI integration tests
          pytest packages/bastion/tests/ -v --tb=short -m "not integration"

      - name: Type Check
        run: |
          pip install mypy
          mypy packages/bastion/src/bastion --ignore-missing-imports || true

      - name: Lint
        run: |
          pip install ruff
          ruff check packages/bastion/src/bastion/ || true

  # Seeder tests temporarily disabled - separate subproject with failing tests
  # TODO: Fix seeder test issues:
  # - ANSI escape codes in CLI help assertions
  # - Missing wonderwords dependency  
  # - RandomWord attribute changes in word_generator
  # seeder-tests:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       python-version: ['3.10', '3.11', '3.12']
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6
  #
  #     - name: Set up Python ${{ matrix.python-version }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #
  #     - name: Install seeder dependencies
  #       working-directory: seeder
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e ".[dev]"
  #
  #     - name: Run Seeder Tests
  #       working-directory: seeder
  #       run: |
  #         pytest tests/ -v --tb=short
  #
  #     - name: Type Check Seeder
  #       working-directory: seeder
  #       run: |
  #         mypy src/seeder --ignore-missing-imports || true

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Security Checks
        run: |
          echo "üîç Running security checks..."
          
          # Check for hardcoded secrets patterns
          if grep -rE "(password|secret|key|token)\s*=\s*['\"][^'\"]{8,}['\"]" packages/bastion/src/ --include="*.py" | grep -v "test" | grep -v "#" | grep -v "example"; then
            echo "‚ö†Ô∏è Potential hardcoded secrets found"
          fi
          
          # Check for personal data patterns
          if grep -rE "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" packages/bastion/src/ --include="*.py" | grep -v "example.com" | grep -v "test" | grep -v "#"; then
            echo "‚ö†Ô∏è Potential real email addresses found"
          fi
          
          echo "‚úÖ Security scan complete"
