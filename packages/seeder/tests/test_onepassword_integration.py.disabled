#!/usr/bin/env python3
"""
Unit tests for 1Password integration.

Tests the OnePassword integration module with mocked 1Password SDK calls
to ensure proper functionality without requiring actual 1Password credentials.
"""

import asyncio
import unittest
from unittest.mock import AsyncMock, patch, Mock

# Import the modules we're testing
from seeder.integrations.onepassword_integration import (
    OnePasswordManager,
    OnePasswordItem,
    OnePasswordError,
    OnePasswordSession,
    create_card_title,
    validate_seed_for_1password,
    demo_1password_integration
)


class TestOnePasswordManager(unittest.TestCase):
    """Test the OnePasswordManager class."""

    def setUp(self):
        """Set up test fixtures."""
        self.manager = OnePasswordManager()

    def test_manager_initialization(self):
        """Test that OnePasswordManager initializes correctly."""
        self.assertIsNone(self.manager.client)
        self.assertFalse(self.manager.authenticated)

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_authentication_success(self, mock_client_class):
        """Test successful authentication."""
        # Mock the client
        mock_client = AsyncMock()
        mock_client_class.return_value = mock_client
        
        # Test authentication
        await self.manager.authenticate(
            token="test_token",
            integration_name="test_seeder",
            integration_version="1.0.0"
        )
        
        self.assertTrue(self.manager.authenticated)
        self.assertEqual(self.manager.client, mock_client)
        mock_client_class.assert_called_once_with(
            service_account_token="test_token",
            integration_name="test_seeder",
            integration_version="1.0.0"
        )

    def test_ensure_authenticated_raises_when_not_authenticated(self):
        """Test that ensure_authenticated raises when not authenticated."""
        with self.assertRaises(OnePasswordError) as context:
            self.manager.ensure_authenticated()
        
        self.assertIn("Not authenticated", str(context.exception))

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_list_vaults(self, mock_client_class):
        """Test listing vaults."""
        # Setup
        mock_client = AsyncMock()
        mock_client_class.return_value = mock_client
        
        # Mock vault data
        mock_vaults = [
            Mock(id="vault1", title="Personal"),
            Mock(id="vault2", title="Work")
        ]
        mock_client.vaults.list.return_value = mock_vaults
        
        # Authenticate first
        await self.manager.authenticate(token="test_token")
        
        # Test list_vaults
        vaults = await self.manager.list_vaults()
        
        expected = [
            {"id": "vault1", "title": "Personal"},
            {"id": "vault2", "title": "Work"}
        ]
        self.assertEqual(vaults, expected)

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_save_seed_card(self, mock_client_class):
        """Test saving a seed card."""
        # Setup
        mock_client = AsyncMock()
        mock_client_class.return_value = mock_client
        
        # Mock created item
        mock_item = Mock()
        mock_item.id = "item123"
        mock_client.items.create.return_value = mock_item
        
        # Authenticate first
        await self.manager.authenticate(token="test_token")
        
        # Test save_seed_card
        item_id = await self.manager.save_seed_card(
            card_id="TEST.01.01",
            seed_phrase="test seed phrase",
            seed_type="BIP-39",
            sha512_hash="test_hash",
            vault_id="vault1"
        )
        
        self.assertEqual(item_id, "item123")
        mock_client.items.create.assert_called_once()

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_load_seed_phrase(self, mock_client_class):
        """Test loading a seed phrase."""
        # Setup
        mock_client = AsyncMock()
        mock_client_class.return_value = mock_client
        
        # Mock item with fields
        mock_item = Mock()
        mock_item.fields = [
            Mock(label="Seed Phrase", value="test mnemonic words"),
            Mock(label="Seed Type", value="BIP-39")
        ]
        mock_client.items.get.return_value = mock_item
        
                # Authenticate first
        await self.manager.authenticate(token="test_token")
        
        # Test load_seed_phrase
        seed_phrase, seed_type = await self.manager.load_seed_phrase("vault1", "item123")
        
        self.assertEqual(seed_phrase, "test mnemonic words")
        self.assertEqual(seed_type, "BIP-39")

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_search_seed_items(self, mock_client_class):
        """Test searching for seed items."""
        # Setup
        mock_client = AsyncMock()
        mock_client_class.return_value = mock_client
        
        # Mock vault list
        mock_vaults = [Mock(id="vault1")]
        mock_client.vaults.list.return_value = mock_vaults
        
        # Mock item search results
        mock_items = [
            Mock(
                id="item1",
                title="Seed Card TEST.01.01",
                tags=["seed-card"],
                vault=Mock(id="vault1")
            )
        ]
        mock_client.items.list.return_value = mock_items
        
        # Authenticate first
        await self.manager.authenticate(token="test_token")
        
        # Test search_seed_items
        items = await self.manager.search_seed_items(tag="seed-card")
        
        self.assertEqual(len(items), 1)
        self.assertEqual(items[0].id, "item1")
        self.assertEqual(items[0].title, "Seed Card TEST.01.01")


class TestOnePasswordItem(unittest.TestCase):
    """Test the OnePasswordItem dataclass."""

    def test_onepassword_item_creation(self):
        """Test creating a OnePasswordItem."""
        item = OnePasswordItem(
            id="test123",
            title="Test Item",
            vault="vault1",
            seed_phrase="test phrase",
            seed_type="Simple"
        )
        
        self.assertEqual(item.id, "test123")
        self.assertEqual(item.title, "Test Item")
        self.assertEqual(item.vault, "vault1")
        self.assertEqual(item.seed_phrase, "test phrase")
        self.assertEqual(item.seed_type, "Simple")

    def test_onepassword_item_defaults(self):
        """Test OnePasswordItem with default values."""
        item = OnePasswordItem(
            id="test123",
            title="Test Item",
            vault="vault1"
        )
        
        self.assertIsNone(item.seed_phrase)
        self.assertIsNone(item.seed_type)


class TestOnePasswordSession(unittest.TestCase):
    """Test the OnePasswordSession context manager."""

    @patch('seeder.integrations.onepassword_integration.OnePasswordManager')
    async def test_session_context_manager(self, mock_manager_class):
        """Test OnePasswordSession as async context manager."""
        # Setup
        mock_manager = AsyncMock()
        mock_manager_class.return_value = mock_manager
        
        # Test context manager
        async with OnePasswordSession("test_token") as session:
            self.assertEqual(session, mock_manager)
        
        # Verify authentication was called
        mock_manager.authenticate.assert_called_once_with(
            service_account_token="test_token"
        )

    @patch.dict('os.environ', {'OP_SERVICE_ACCOUNT_TOKEN': 'env_token'})
    @patch('seeder.integrations.onepassword_integration.OnePasswordManager')
    async def test_session_with_env_token(self, mock_manager_class):
        """Test OnePasswordSession using environment variable."""
        # Setup
        mock_manager = AsyncMock()
        mock_manager_class.return_value = mock_manager
        
        # Test context manager without explicit token
        async with OnePasswordSession() as session:
            self.assertEqual(session, mock_manager)
        
        # Verify authentication used environment token
        mock_manager.authenticate.assert_called_once_with(
            service_account_token="env_token"
        )


class TestUtilityFunctions(unittest.TestCase):
    """Test utility functions."""

    def test_create_card_title(self):
        """Test card title creation."""
        title = create_card_title("TEST.01.01", "BIP-39")
        self.assertEqual(title, "Seed Card TEST.01.01 (BIP-39)")
        
        title = create_card_title("WORK.05.03", "Simple")
        self.assertEqual(title, "Seed Card WORK.05.03 (Simple)")

    def test_validate_seed_for_1password_bip39(self):
        """Test BIP-39 seed validation."""
        # Valid BIP-39 (12 words)
        valid_bip39 = "abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"
        self.assertTrue(validate_seed_for_1password(valid_bip39, "BIP-39"))
        
        # Invalid BIP-39 (too few words)
        invalid_bip39 = "abandon abandon abandon"
        self.assertFalse(validate_seed_for_1password(invalid_bip39, "BIP-39"))

    def test_validate_seed_for_1password_simple(self):
        """Test Simple seed validation."""
        # Valid simple seed
        self.assertTrue(validate_seed_for_1password("any text here", "Simple"))
        
        # Empty simple seed
        self.assertFalse(validate_seed_for_1password("", "Simple"))

    def test_validate_seed_for_1password_slip39(self):
        """Test SLIP-39 seed validation."""
        # Valid SLIP-39 shares
        valid_shares = ["share1 word1", "share2 word2"]
        self.assertTrue(validate_seed_for_1password(valid_shares, "SLIP-39"))
        
        # Invalid SLIP-39 (not enough shares)
        invalid_shares = ["single_share"]
        self.assertFalse(validate_seed_for_1password(invalid_shares, "SLIP-39"))


class TestOnePasswordErrors(unittest.TestCase):
    """Test error handling."""

    def test_onepassword_error_inheritance(self):
        """Test that OnePasswordError inherits from SeedCardError."""
        from seeder.core.exceptions import SeedCardError
        
        error = OnePasswordError("Test error")
        self.assertIsInstance(error, SeedCardError)
        self.assertEqual(str(error), "Test error")

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_authentication_failure(self, mock_client_class):
        """Test authentication failure handling."""
        # Setup client to raise exception
        mock_client_class.side_effect = Exception("Authentication failed")
        
        manager = OnePasswordManager()
        
        with self.assertRaises(OnePasswordError) as context:
            await manager.authenticate(token="invalid_token")
        
        self.assertIn("Authentication failed", str(context.exception))

    @patch('seeder.integrations.onepassword_integration.Client')
    async def test_vault_operation_without_authentication(self, mock_client_class):
        """Test that vault operations fail without authentication."""
        manager = OnePasswordManager()
        
        with self.assertRaises(OnePasswordError):
            await manager.list_vaults()


class TestAsyncDemo(unittest.TestCase):
    """Test the demo function."""

    @patch('seeder.integrations.onepassword_integration.OnePasswordSession')
    async def test_demo_1password_integration(self, mock_session_class):
        """Test the demo function."""
        # Setup
        mock_session = AsyncMock()
        mock_session_class.return_value.__aenter__.return_value = mock_session
        
        # Mock methods
        mock_session.list_vaults.return_value = [{"id": "vault1", "title": "Test"}]
        mock_session.search_seed_items.return_value = []
        mock_session.save_seed_card.return_value = "item123"
        
        # Test demo (should not raise)
        try:
            await demo_1password_integration()
        except Exception as e:
            self.fail(f"Demo function raised an exception: {e}")


# Test runner for async tests
class AsyncTestCase(unittest.TestCase):
    """Base class for running async tests."""
    
    def async_test(self, coro):
        """Helper method to run async tests."""
        loop = asyncio.new_event_loop()
        try:
            return loop.run_until_complete(coro)
        finally:
            loop.close()


# Integration tests that require async execution
class TestOnePasswordIntegration(AsyncTestCase):
    """Integration tests for OnePassword functionality."""

    def test_full_workflow_mocked(self):
        """Test a complete workflow with mocked 1Password SDK."""
        async def _test():
            with patch('seeder.integrations.onepassword_integration.Client.authenticate') as mock_authenticate:
                # Setup mock client
                mock_client = AsyncMock()
                mock_authenticate.return_value = mock_client
                
                # Mock responses
                mock_client.vaults.list.return_value = [Mock(id="vault1", title="Test")]
                mock_client.items.create.return_value = Mock(id="item123")
                mock_client.items.get.return_value = Mock(
                    fields=[
                        Mock(id="seed_phrase", title="Seed Phrase", value="test phrase", field_type=None),
                        Mock(id="seed_type", title="Seed Type", value="Simple", field_type=None)
                    ]
                )

                # Test workflow
                manager = OnePasswordManager()
                await manager.authenticate(token="test_token")

                # List vaults
                vaults = await manager.list_vaults()
                self.assertEqual(len(vaults), 1)
                
                # Save seed card
                item_id = await manager.save_seed_card(
                    card_id="TEST.01.01",
                    seed_phrase="test phrase",
                    seed_type="Simple",
                    sha512_hash="test_hash",
                    vault_id="vault1"
                )
                self.assertEqual(item_id, "item123")
                
                # Load seed phrase
                phrase, seed_type = await manager.load_seed_phrase("vault1", "item123")
                self.assertEqual(phrase, "test phrase")
                self.assertEqual(seed_type, "Simple")
        
        self.async_test(_test())
if __name__ == "__main__":
    # Run the tests
    unittest.main(verbosity=2)